# Apache性能优化配置
# 将此配置添加到Apache配置文件中

# 1. 启用必要的模块
LoadModule deflate_module modules/mod_deflate.so
LoadModule expires_module modules/mod_expires.so
LoadModule headers_module modules/mod_headers.so
LoadModule rewrite_module modules/mod_rewrite.so

# 2. 启用压缩
<IfModule mod_deflate.c>
    # 压缩HTML, CSS, JavaScript, Text, XML
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    
    # 排除图片压缩
    SetEnvIfNoCase Request_URI \
        \.(?:gif|jpe?g|png)$ no-gzip dont-vary
    SetEnvIfNoCase Request_URI \
        \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    SetEnvIfNoCase Request_URI \
        \.pdf$ no-gzip dont-vary
</IfModule>

# 3. 设置浏览器缓存
<IfModule mod_expires.c>
    ExpiresActive On
    
    # 图片缓存1个月
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 month"
    
    # CSS和JS缓存1个月
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    
    # HTML缓存1小时
    ExpiresByType text/html "access plus 1 hour"
    
    # 其他文件缓存1周
    ExpiresDefault "access plus 1 week"
</IfModule>

# 4. 安全头设置
<IfModule mod_headers.c>
    # 防止点击劫持
    Header always append X-Frame-Options SAMEORIGIN
    
    # 防止XSS攻击
    Header set X-Content-Type-Options nosniff
    
    # 禁用服务器签名
    ServerTokens Prod
    ServerSignature Off
</IfModule>

# 5. PHP优化配置
<IfModule php7_module>
    # 启用OPcache
    php_value opcache.enable 1
    php_value opcache.memory_consumption 128
    php_value opcache.interned_strings_buffer 8
    php_value opcache.max_accelerated_files 4000
    php_value opcache.revalidate_freq 60
    php_value opcache.fast_shutdown 1
    
    # 内存限制
    php_value memory_limit 256M
    
    # 执行时间
    php_value max_execution_time 300
    
    # 上传限制
    php_value upload_max_filesize 50M
    php_value post_max_size 50M
</IfModule>

# 6. 重写规则优化
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # 强制HTTPS
    # RewriteCond %{HTTPS} off
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # 移除index.php
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ index.php [QSA,L]
    
    # 静态资源缓存
    RewriteRule \.(css|js|png|jpg|jpeg|gif|ico|svg)$ - [L,NC]
</IfModule>

# 7. MPM优化配置（根据服务器内存调整）
<IfModule mpm_prefork_module>
    StartServers 5
    MinSpareServers 5
    MaxSpareServers 10
    MaxRequestWorkers 150
    MaxConnectionsPerChild 1000
</IfModule>

<IfModule mpm_worker_module>
    StartServers 3
    MinSpareThreads 75
    MaxSpareThreads 250
    ThreadsPerChild 25
    MaxRequestWorkers 400
    MaxConnectionsPerChild 1000
</IfModule>

<IfModule mpm_event_module>
    StartServers 3
    MinSpareThreads 75
    MaxSpareThreads 250
    ThreadsPerChild 25
    MaxRequestWorkers 400
    MaxConnectionsPerChild 1000
</IfModule>

# 8. 日志优化
# 减少日志记录
LogLevel warn

# 9. 禁用不必要的模块
# 在httpd.conf中注释掉以下模块（如果不需要）
# LoadModule authn_file_module modules/mod_authn_file.so
# LoadModule authn_dbm_module modules/mod_authn_dbm.so
# LoadModule authn_anon_module modules/mod_authn_anon.so
# LoadModule authn_dbd_module modules/mod_authn_dbd.so
# LoadModule authn_default_module modules/mod_authn_default.so

# 10. 虚拟主机优化
<VirtualHost *:80>
    DocumentRoot "c:/shenhau/www"
    ServerName localhost
    
    # 启用所有优化
    <Directory "c:/shenhau/www">
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        
        # 启用压缩
        <IfModule mod_deflate.c>
            SetOutputFilter DEFLATE
        </IfModule>
        
        # 启用缓存
        <IfModule mod_expires.c>
            ExpiresActive On
        </IfModule>
    </Directory>
    
    # 日志配置
    ErrorLog "logs/game_error.log"
    CustomLog "logs/game_access.log" combined
</VirtualHost>

# 11. 性能监控配置
<IfModule mod_status.c>
    <Location "/server-status">
        SetHandler server-status
        Require local
    </Location>
</IfModule>

# 12. 连接数限制
<IfModule mod_evasive24.c>
    DOSHashTableSize    2048
    DOSPageCount        3
    DOSPageInterval     1
    DOSSiteCount        50
    DOSSiteInterval     1
    DOSBlockingPeriod   10
</IfModule>